#!/bin/bash

# é¡¹ç›®çº¦æŸæ‰§è¡Œæœºåˆ¶ - è‡ªåŠ¨åŠ è½½
# æ­¤è„šæœ¬ç¡®ä¿åœ¨ä»»ä½•æ—¶å€™éƒ½ä¸¥æ ¼éµå®ˆPROJECT_REQUIREMENTS.mdæ–‡æ¡£çº¦æŸ

# æ£€æŸ¥æ˜¯å¦åœ¨é¡¹ç›®ç›®å½•ä¸­
if [ -f "PROJECT_REQUIREMENTS.md" ]; then
    # è®¾ç½®é¡¹ç›®çº¦æŸæ£€æŸ¥åˆ«å
    alias check-constraints="./scripts/pre_commit_check.sh"
    alias validate-doc="./scripts/validate_document.sh"
    alias constraint-check="./scripts/constraint_check.sh"
    
    # åˆ›å»ºè‡ªåŠ¨æ£€æŸ¥å‡½æ•°
    auto_constraint_check() {
        if [ -f "scripts/pre_commit_check.sh" ]; then
            echo "ğŸ”’ è‡ªåŠ¨æ‰§è¡Œçº¦æŸæ£€æŸ¥..."
            ./scripts/pre_commit_check.sh
            if [ $? -ne 0 ]; then
                echo "âŒ çº¦æŸæ£€æŸ¥å¤±è´¥ï¼è¯·ä¿®å¤é—®é¢˜åå†ç»§ç»­ã€‚"
                return 1
            fi
        fi
    }
    
    # åˆ›å»ºä»£ç ä¿®æ”¹å‰è‡ªåŠ¨æ£€æŸ¥å‡½æ•°
    pre_edit_check() {
        echo "ğŸ” ä»£ç ä¿®æ”¹å‰æ£€æŸ¥..."
        if [ -f "scripts/pre_commit_check.sh" ]; then
            ./scripts/pre_commit_check.sh
            CHECK_RESULT=$?
            if [ $CHECK_RESULT -ne 0 ]; then
                echo ""
                echo "ğŸš« çº¦æŸæ£€æŸ¥å¤±è´¥ï¼Œä¸èƒ½ç»§ç»­ä»£ç ä¿®æ”¹ï¼"
                echo "è¯·å…ˆè§£å†³ä»¥ä¸‹é—®é¢˜ï¼š"
                echo "1. ç¡®ä¿PROJECT_REQUIREMENTS.mdæ–‡æ¡£æ­£ç¡®"
                echo "2. ä¿®å¤ä»£ç è¿è§„é—®é¢˜"
                echo "3. ç¡®è®¤ä¿®æ”¹ç¬¦åˆæ–‡æ¡£è¦æ±‚"
                echo ""
                echo "ä¿®å¤å®Œæˆåï¼Œè¿è¡Œ: check-constraints"
                return 1
            fi
        fi
        echo "âœ… çº¦æŸæ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥å¼€å§‹ä»£ç ä¿®æ”¹"
    }
    
    # åˆ›å»ºéœ€æ±‚å˜æ›´å‡½æ•°
    update_requirements() {
        echo "ğŸ“ æ›´æ–°é¡¹ç›®éœ€æ±‚æ–‡æ¡£..."
        vim PROJECT_REQUIREMENTS.md
        echo "ğŸ” éªŒè¯æ›´æ–°åçš„æ–‡æ¡£..."
        if [ -f "scripts/validate_document.sh" ]; then
            ./scripts/validate_document.sh
            if [ $? -eq 0 ]; then
                echo "âœ… æ–‡æ¡£æ›´æ–°æˆåŠŸï¼Œå¯ä»¥ç»§ç»­ä»£ç ä¿®æ”¹"
            else
                echo "âŒ æ–‡æ¡£æ›´æ–°å¤±è´¥ï¼Œè¯·é‡æ–°ç¼–è¾‘"
            fi
        fi
    }
    
    # åˆ›å»ºçº¦æŸçŠ¶æ€æ£€æŸ¥å‡½æ•°
    constraint_status() {
        echo "ğŸ“Š çº¦æŸæ‰§è¡ŒçŠ¶æ€æ£€æŸ¥"
        echo "========================"
        
        if [ -f "PROJECT_REQUIREMENTS.md" ]; then
            echo "âœ… é¡¹ç›®éœ€æ±‚æ–‡æ¡£: å­˜åœ¨"
            echo "ğŸ“„ æ–‡æ¡£ç‰ˆæœ¬: $(grep "æœ¬æ–‡æ¡£ç‰ˆæœ¬ï¼š" PROJECT_REQUIREMENTS.md | cut -d'ï¼š' -f2 | tr -d ' ')"
            echo "ğŸ“Š æ–‡æ¡£è¡Œæ•°: $(wc -l < PROJECT_REQUIREMENTS.md)è¡Œ"
        else
            echo "âŒ é¡¹ç›®éœ€æ±‚æ–‡æ¡£: ä¸å­˜åœ¨"
            return 1
        fi
        
        if [ -d "scripts" ]; then
            echo "âœ… çº¦æŸè„šæœ¬ç›®å½•: å­˜åœ¨"
            if [ -x "scripts/pre_commit_check.sh" ]; then
                echo "âœ… é¢„æäº¤æ£€æŸ¥è„šæœ¬: å¯æ‰§è¡Œ"
            else
                echo "âŒ é¢„æäº¤æ£€æŸ¥è„šæœ¬: ä¸å¯æ‰§è¡Œ"
            fi
        else
            echo "âŒ çº¦æŸè„šæœ¬ç›®å½•: ä¸å­˜åœ¨"
        fi
        
        echo "ğŸ”’ çº¦æŸæœºåˆ¶çŠ¶æ€: æ¿€æ´»"
        echo "ğŸ“‹ å½“å‰æ—¶é—´: $(date)"
    }
    
    # åˆ›å»ºæé†’å‡½æ•°
    constraint_reminder() {
        echo ""
        echo "ğŸš¨ é‡è¦æé†’ï¼š"
        echo "ğŸ“‹ ä¸¥æ ¼éµå¾ªPROJECT_REQUIREMENTS.mdæ–‡æ¡£çº¦æŸ"
        echo "ğŸ“ éœ€æ±‚å˜æ›´ -> å…ˆæ›´æ–°æ–‡æ¡£ -> å†ä¿®æ”¹ä»£ç "
        echo "ğŸ”’ è¿åçº¦æŸçš„ä»£ç å°†è¢«æ‹’ç»"
        echo "ğŸ” ä»£ç ä¿®æ”¹å‰è¯·è¿è¡Œ: pre_edit_check"
        echo ""
    }
    
    # è®¾ç½®æç¤ºç¬¦å‰ç¼€
    PS1_PREFIX="[ğŸ”’çº¦æŸ] "
    
    # åœ¨æ¯ä¸ªå‘½ä»¤å‰æ˜¾ç¤ºæé†’ï¼ˆå¯é€‰ï¼Œæ³¨é‡Šæ‰é¿å…è¿‡äºé¢‘ç¹ï¼‰
    # trap 'constraint_reminder' DEBUG
    
    # æ˜¾ç¤ºçº¦æŸæ¿€æ´»ä¿¡æ¯
    echo ""
    echo "ğŸ”’ é¡¹ç›®çº¦æŸæ‰§è¡Œæœºåˆ¶å·²æ¿€æ´»"
    echo "ğŸ“‹ ä¸¥æ ¼éµå¾ªPROJECT_REQUIREMENTS.mdæ–‡æ¡£"
    constraint_reminder
    
    # åˆ›å»ºå®‰å…¨ç¼–è¾‘å‡½æ•°
    safe_edit() {
        echo "ğŸ” æ‰§è¡Œç¼–è¾‘å‰çº¦æŸæ£€æŸ¥..."
        pre_edit_check
        if [ $? -eq 0 ]; then
            vim "$@"
        else
            echo "âŒ çº¦æŸæ£€æŸ¥å¤±è´¥ï¼Œç¼–è¾‘æ“ä½œå·²å–æ¶ˆ"
            return 1
        fi
    }
    
    # é‡å†™å¸¸ç”¨ç¼–è¾‘å‘½ä»¤
    alias vim='safe_edit'
    alias nano='safe_edit'
    alias code='safe_edit'
    
    # æ·»åŠ åˆ°PATHï¼ˆå¦‚æœéœ€è¦ï¼‰
    # export PATH="$PWD/scripts:$PATH"
    
fi

# åˆ›å»ºå…¨å±€çº¦æŸæ£€æŸ¥å‡½æ•°
global_constraint_check() {
    echo "ğŸŒ å…¨å±€çº¦æŸæ£€æŸ¥..."
    
    # æŸ¥æ‰¾åŒ…å«PROJECT_REQUIREMENTS.mdçš„ç›®å½•
    PROJECT_DIRS=$(find . -name "PROJECT_REQUIREMENTS.md" -type f 2>/dev/null | while read file; do dirname "$file"; done)
    
    if [ -z "$PROJECT_DIRS" ]; then
        echo "âŒ æœªæ‰¾åˆ°åŒ…å«PROJECT_REQUIREMENTS.mdçš„é¡¹ç›®ç›®å½•"
        return 1
    fi
    
    for dir in $PROJECT_DIRS; do
        echo ""
        echo "ğŸ“ æ£€æŸ¥é¡¹ç›®: $dir"
        cd "$dir" || continue
        
        if [ -f "scripts/pre_commit_check.sh" ]; then
            ./scripts/pre_commit_check.sh
        else
            echo "âš ï¸  é¡¹ç›®ç¼ºå°‘çº¦æŸæ£€æŸ¥è„šæœ¬"
        fi
        
        cd - > /dev/null
    done
}

# å¯¼å‡ºå‡½æ•°
export -f auto_constraint_check
export -f pre_edit_check
export -f update_requirements
export -f constraint_status
export -f safe_edit
export -f global_constraint_check

