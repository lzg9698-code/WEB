#!/bin/bash

echo "ðŸ§ª æµ‹è¯•çº¦æŸæ‰§è¡Œæœºåˆ¶..."
echo "========================================"

# æµ‹è¯•1ï¼šæ£€æŸ¥æ–‡æ¡£æ˜¯å¦å­˜åœ¨
echo "ðŸ“‹ æµ‹è¯•1ï¼šæ–‡æ¡£å­˜åœ¨æ€§æ£€æŸ¥..."
if [ ! -f "PROJECT_REQUIREMENTS.md" ]; then
    echo "âŒ æµ‹è¯•å¤±è´¥ï¼šPROJECT_REQUIREMENTS.mdä¸å­˜åœ¨"
    exit 1
else
    echo "âœ… æµ‹è¯•1é€šè¿‡ï¼šæ–‡æ¡£å­˜åœ¨"
fi

# æµ‹è¯•2ï¼šæ£€æŸ¥è„šæœ¬æ˜¯å¦å­˜åœ¨ä¸”æœ‰æ‰§è¡Œæƒé™
echo ""
echo "ðŸ“‹ æµ‹è¯•2ï¼šè„šæœ¬æƒé™æ£€æŸ¥..."
REQUIRED_SCRIPTS=(
    "validate_document.sh"
    "constraint_check.sh" 
    "pre_commit_check.sh"
    "start.sh"
    "test_constraints.sh"
)

for script in "${REQUIRED_SCRIPTS[@]}"; do
    if [ ! -f "scripts/$script" ]; then
        echo "âŒ æµ‹è¯•å¤±è´¥ï¼šè„šæœ¬ä¸å­˜åœ¨ - scripts/$script"
        exit 1
    fi
    
    if [ ! -x "scripts/$script" ]; then
        echo "âŒ æµ‹è¯•å¤±è´¥ï¼šè„šæœ¬æ— æ‰§è¡Œæƒé™ - scripts/$script"
        exit 1
    fi
done
echo "âœ… æµ‹è¯•2é€šè¿‡ï¼šæ‰€æœ‰è„šæœ¬å­˜åœ¨ä¸”æœ‰æ‰§è¡Œæƒé™"

# æµ‹è¯•3ï¼šæ–‡æ¡£æ ¡éªŒè„šæœ¬æµ‹è¯•
echo ""
echo "ðŸ“‹ æµ‹è¯•3ï¼šæ–‡æ¡£æ ¡éªŒè„šæœ¬æµ‹è¯•..."
./scripts/validate_document.sh > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "âœ… æµ‹è¯•3é€šè¿‡ï¼šæ–‡æ¡£æ ¡éªŒè„šæœ¬æ­£å¸¸"
else
    echo "âŒ æµ‹è¯•å¤±è´¥ï¼šæ–‡æ¡£æ ¡éªŒè„šæœ¬å¼‚å¸¸"
    echo "è¯·æ£€æŸ¥PROJECT_REQUIREMENTS.mdæ–‡æ¡£å®Œæ•´æ€§"
    exit 1
fi

# æµ‹è¯•4ï¼šçº¦æŸæ£€æŸ¥è„šæœ¬æµ‹è¯•
echo ""
echo "ðŸ“‹ æµ‹è¯•4ï¼šçº¦æŸæ£€æŸ¥è„šæœ¬æµ‹è¯•..."
./scripts/constraint_check.sh > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "âœ… æµ‹è¯•4é€šè¿‡ï¼šçº¦æŸæ£€æŸ¥è„šæœ¬æ­£å¸¸"
else
    echo "âŒ æµ‹è¯•å¤±è´¥ï¼šçº¦æŸæ£€æŸ¥è„šæœ¬å¼‚å¸¸"
    echo "è¯·æ£€æŸ¥æ˜¯å¦æœ‰ä»£ç è¿è§„"
    exit 1
fi

# æµ‹è¯•5ï¼šé¢„æäº¤æ£€æŸ¥è„šæœ¬æµ‹è¯•
echo ""
echo "ðŸ“‹ æµ‹è¯•5ï¼šé¢„æäº¤æ£€æŸ¥è„šæœ¬æµ‹è¯•..."
echo "continue" | ./scripts/pre_commit_check.sh > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "âœ… æµ‹è¯•5é€šè¿‡ï¼šé¢„æäº¤æ£€æŸ¥è„šæœ¬æ­£å¸¸"
else
    echo "âŒ æµ‹è¯•å¤±è´¥ï¼šé¢„æäº¤æ£€æŸ¥è„šæœ¬å¼‚å¸¸"
    echo "è¯·æ£€æŸ¥æ•´ä½“çº¦æŸæœºåˆ¶"
    exit 1
fi

# æµ‹è¯•6ï¼šåˆ›å»ºä¸´æ—¶è¿è§„æ–‡ä»¶æµ‹è¯•æ£€æµ‹æœºåˆ¶
echo ""
echo "ðŸ“‹ æµ‹è¯•6ï¼šè¿è§„æ£€æµ‹æœºåˆ¶æµ‹è¯•..."

# åˆ›å»ºä¸´æ—¶è¿è§„ä»£ç 
cat > test_violation.py << 'INNER_EOF'
# æµ‹è¯•è¿è§„ä»£ç  - ä½¿ç”¨æ•°æ®åº“ï¼ˆè¿åçº¦æŸï¼‰
import sqlite3
import mysql.connector

# æµ‹è¯•è¿è§„ä»£ç  - ç”¨æˆ·æƒé™ï¼ˆè¿åçº¦æŸï¼‰
def user_auth():
    pass

# æµ‹è¯•è¿è§„ä»£ç  - CAD/CAMï¼ˆè¿åçº¦æŸï¼‰
def cad_simulation():
    pass
INNER_EOF

# è¿è¡Œçº¦æŸæ£€æŸ¥ï¼Œåº”è¯¥æ£€æµ‹åˆ°è¿è§„
./scripts/constraint_check.sh > /dev/null 2>&1
VIOLATION_DETECTED=$?

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
rm -f test_violation.py

if [ $VIOLATION_DETECTED -ne 0 ]; then
    echo "âœ… æµ‹è¯•6é€šè¿‡ï¼šè¿è§„æ£€æµ‹æœºåˆ¶æ­£å¸¸å·¥ä½œ"
else
    echo "âŒ æµ‹è¯•å¤±è´¥ï¼šè¿è§„æ£€æµ‹æœºåˆ¶æœªæ£€æµ‹åˆ°è¿è§„"
    echo "çº¦æŸæ£€æŸ¥è„šæœ¬å¯èƒ½å­˜åœ¨é—®é¢˜"
    exit 1
fi

# æµ‹è¯•7ï¼šåˆ›å»ºä¸´æ—¶æŠ€æœ¯æ ˆè¿è§„æµ‹è¯•
echo ""
echo "ðŸ“‹ æµ‹è¯•7ï¼šæŠ€æœ¯æ ˆè¿è§„æ£€æµ‹æµ‹è¯•..."

# åˆ›å»ºä¸´æ—¶package.jsonä½¿ç”¨è¿è§„æŠ€æœ¯æ ˆ
cat > package.json << 'INNER_EOF'
{
  "name": "test-project",
  "version": "1.0.0",
  "dependencies": {
    "react": "^18.0.0",
    "angular": "^14.0.0"
  }
}
INNER_EOF

# è¿è¡Œçº¦æŸæ£€æŸ¥ï¼Œåº”è¯¥æ£€æµ‹åˆ°æŠ€æœ¯æ ˆè¿è§„
./scripts/constraint_check.sh > /dev/null 2>&1
TECH_VIOLATION_DETECTED=$?

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
rm -f package.json

if [ $TECH_VIOLATION_DETECTED -ne 0 ]; then
    echo "âœ… æµ‹è¯•7é€šè¿‡ï¼šæŠ€æœ¯æ ˆè¿è§„æ£€æµ‹æ­£å¸¸"
else
    echo "âŒ æµ‹è¯•å¤±è´¥ï¼šæŠ€æœ¯æ ˆè¿è§„æ£€æµ‹æœªç”Ÿæ•ˆ"
    echo "çº¦æŸæ£€æŸ¥è„šæœ¬å¯èƒ½å­˜åœ¨é—®é¢˜"
    exit 1
fi

# æµ‹è¯•8ï¼šå¯åŠ¨è„šæœ¬æµ‹è¯•
echo ""
echo "ðŸ“‹ æµ‹è¯•8ï¼šå¯åŠ¨è„šæœ¬æµ‹è¯•..."
./scripts/start.sh > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "âœ… æµ‹è¯•8é€šè¿‡ï¼šå¯åŠ¨è„šæœ¬æ­£å¸¸"
else
    echo "âŒ æµ‹è¯•å¤±è´¥ï¼šå¯åŠ¨è„šæœ¬å¼‚å¸¸"
    exit 1
fi

# æµ‹è¯•9ï¼šæ–‡æ¡£å®Œæ•´æ€§æµ‹è¯•
echo ""
echo "ðŸ“‹ æµ‹è¯•9ï¼šæ–‡æ¡£å®Œæ•´æ€§æµ‹è¯•..."

# æ£€æŸ¥å¿…è¦ç« èŠ‚
REQUIRED_SECTIONS=(
    "é¡¹ç›®æ¦‚è¿°"
    "ç³»ç»Ÿæž¶æž„" 
    "æ¨¡å—è®¾è®¡"
    "æ¨¡æ¿åŒ…è§„èŒƒ"
    "é¡¹ç›®è¾¹ç•Œå’Œçº¦æŸ"
    "æ–‡æ¡£çº¦æŸè¯´æ˜Ž"
)

MISSING_SECTIONS=()
for section in "${REQUIRED_SECTIONS[@]}"; do
    if ! grep -q "$section" PROJECT_REQUIREMENTS.md; then
        MISSING_SECTIONS+=("$section")
    fi
done

if [ ${#MISSING_SECTIONS[@]} -eq 0 ]; then
    echo "âœ… æµ‹è¯•9é€šè¿‡ï¼šæ–‡æ¡£å®Œæ•´æ€§æ­£å¸¸"
else
    echo "âŒ æµ‹è¯•å¤±è´¥ï¼šæ–‡æ¡£ç¼ºå°‘å¿…è¦ç« èŠ‚"
    for section in "${MISSING_SECTIONS[@]}"; do
        echo "   ç¼ºå°‘ï¼š$section"
    done
    exit 1
fi

# æµ‹è¯•10ï¼šçº¦æŸæ–‡ä»¶å­˜åœ¨æ€§æµ‹è¯•
echo ""
echo "ðŸ“‹ æµ‹è¯•10ï¼šçº¦æŸæ–‡ä»¶å­˜åœ¨æ€§æµ‹è¯•..."

CONSTRAINT_FILES=(
    "PROJECT_REQUIREMENTS.md"
    "CONSTRAINT_ENFORCEMENT.md"
    "README.md"
    ".bashrc_constraint"
)

for file in "${CONSTRAINT_FILES[@]}"; do
    if [ ! -f "$file" ]; then
        echo "âŒ æµ‹è¯•å¤±è´¥ï¼šçº¦æŸæ–‡ä»¶ä¸å­˜åœ¨ - $file"
        exit 1
    fi
done

echo "âœ… æµ‹è¯•10é€šè¿‡ï¼šæ‰€æœ‰çº¦æŸæ–‡ä»¶å­˜åœ¨"

# æµ‹è¯•æŠ¥å‘Š
echo ""
echo "========================================"
echo "ðŸŽ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼"
echo ""
echo "âœ… æµ‹è¯•1ï¼šæ–‡æ¡£å­˜åœ¨æ€§æ£€æŸ¥"
echo "âœ… æµ‹è¯•2ï¼šè„šæœ¬æƒé™æ£€æŸ¥"
echo "âœ… æµ‹è¯•3ï¼šæ–‡æ¡£æ ¡éªŒè„šæœ¬æµ‹è¯•"
echo "âœ… æµ‹è¯•4ï¼šçº¦æŸæ£€æŸ¥è„šæœ¬æµ‹è¯•"
echo "âœ… æµ‹è¯•5ï¼šé¢„æäº¤æ£€æŸ¥è„šæœ¬æµ‹è¯•"
echo "âœ… æµ‹è¯•6ï¼šè¿è§„æ£€æµ‹æœºåˆ¶æµ‹è¯•"
echo "âœ… æµ‹è¯•7ï¼šæŠ€æœ¯æ ˆè¿è§„æ£€æµ‹æµ‹è¯•"
echo "âœ… æµ‹è¯•8ï¼šå¯åŠ¨è„šæœ¬æµ‹è¯•"
echo "âœ… æµ‹è¯•9ï¼šæ–‡æ¡£å®Œæ•´æ€§æµ‹è¯•"
echo "âœ… æµ‹è¯•10ï¼šçº¦æŸæ–‡ä»¶å­˜åœ¨æ€§æµ‹è¯•"
echo ""
echo "ðŸ”’ çº¦æŸæ‰§è¡Œæœºåˆ¶å®Œå…¨æ­£å¸¸"
echo "ðŸ›¡ï¸ é¡¹ç›®å—åˆ°å®Œæ•´ä¿æŠ¤"
echo "ðŸ“‹ ä¸¥æ ¼éµå®ˆPROJECT_REQUIREMENTS.md"
echo "========================================"

# ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
TEST_REPORT="CONSTRAINT_TEST_REPORT_$(date +%Y%m%d_%H%M%S).txt"
cat > "$TEST_REPORT" << EOF
çº¦æŸæ‰§è¡Œæœºåˆ¶æµ‹è¯•æŠ¥å‘Š
ç”Ÿæˆæ—¶é—´: $(date)
é¡¹ç›®è·¯å¾„: $(pwd)

æµ‹è¯•ç»“æžœ: âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡

æµ‹è¯•é¡¹ç›®:
1. æ–‡æ¡£å­˜åœ¨æ€§æ£€æŸ¥: âœ… é€šè¿‡
2. è„šæœ¬æƒé™æ£€æŸ¥: âœ… é€šè¿‡
3. æ–‡æ¡£æ ¡éªŒè„šæœ¬æµ‹è¯•: âœ… é€šè¿‡
4. çº¦æŸæ£€æŸ¥è„šæœ¬æµ‹è¯•: âœ… é€šè¿‡
5. é¢„æäº¤æ£€æŸ¥è„šæœ¬æµ‹è¯•: âœ… é€šè¿‡
6. è¿è§„æ£€æµ‹æœºåˆ¶æµ‹è¯•: âœ… é€šè¿‡
7. æŠ€æœ¯æ ˆè¿è§„æ£€æµ‹æµ‹è¯•: âœ… é€šè¿‡
8. å¯åŠ¨è„šæœ¬æµ‹è¯•: âœ… é€šè¿‡
9. æ–‡æ¡£å®Œæ•´æ€§æµ‹è¯•: âœ… é€šè¿‡
10. çº¦æŸæ–‡ä»¶å­˜åœ¨æ€§æµ‹è¯•: âœ… é€šè¿‡

æ–‡æ¡£ç‰ˆæœ¬: $(grep "æœ¬æ–‡æ¡£ç‰ˆæœ¬ï¼š" PROJECT_REQUIREMENTS.md | cut -d'ï¼š' -f2 | tr -d ' ')
çº¦æŸæœºåˆ¶ç‰ˆæœ¬: 1.0.0

çŠ¶æ€: ðŸ›¡ï¸ çº¦æŸæ‰§è¡Œæœºåˆ¶å®Œå…¨æ­£å¸¸ï¼Œé¡¹ç›®å—åˆ°å®Œæ•´ä¿æŠ¤

è¯´æ˜Ž:
- æ‰€æœ‰çº¦æŸæ£€æŸ¥è„šæœ¬æ­£å¸¸å·¥ä½œ
- è¿è§„æ£€æµ‹æœºåˆ¶æœ‰æ•ˆ
- æ–‡æ¡£å®Œæ•´æ€§è‰¯å¥½
- æŠ€æœ¯æ ˆçº¦æŸæœ‰æ•ˆ
- é¡¹ç›®å¯åŠ¨æ­£å¸¸

å»ºè®®:
- å®šæœŸè¿è¡Œæ­¤æµ‹è¯•è„šæœ¬éªŒè¯çº¦æŸæœºåˆ¶
- åœ¨é‡è¦ä¿®æ”¹å‰è¿è¡Œå®Œæ•´æµ‹è¯•
- ä¿æŒæ–‡æ¡£å’Œè„šæœ¬çš„åŒæ­¥æ›´æ–°
