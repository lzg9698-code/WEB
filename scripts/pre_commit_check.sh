#!/bin/bash

echo "ðŸš€ æ‰§è¡Œä»£ç ä¿®æ”¹å‰å¼ºåˆ¶æ£€æŸ¥..."
echo "========================================"

# æ£€æŸ¥æ˜¯å¦åœ¨æ­£ç¡®çš„é¡¹ç›®ç›®å½•ä¸­
if [ ! -f "PROJECT_REQUIREMENTS.md" ]; then
    echo "âŒ é”™è¯¯ï¼šæœªåœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­ï¼"
    echo "è¯·ç¡®ä¿åœ¨åŒ…å«PROJECT_REQUIREMENTS.mdçš„ç›®å½•ä¸­æ‰§è¡Œæ­¤è„šæœ¬ã€‚"
    exit 1
fi

# æ˜¾ç¤ºå½“å‰æ–‡æ¡£ç‰ˆæœ¬
echo "ðŸ“„ å½“å‰é¡¹ç›®éœ€æ±‚æ–‡æ¡£ç‰ˆæœ¬ï¼š"
grep "æœ¬æ–‡æ¡£ç‰ˆæœ¬ï¼š" PROJECT_REQUIREMENTS.md | cut -d':' -f2

echo ""
echo "ðŸ” æ­¥éª¤1ï¼šæ ¡éªŒéœ€æ±‚æ–‡æ¡£å®Œæ•´æ€§..."
./scripts/validate_document.sh
DOC_CHECK_RESULT=$?

if [ $DOC_CHECK_RESULT -ne 0 ]; then
    echo ""
    echo "âŒ æ–‡æ¡£æ ¡éªŒå¤±è´¥ï¼"
    echo "ðŸ› ï¸  è§£å†³æ–¹æ¡ˆï¼š"
    echo "   1. ç¡®ä¿PROJECT_REQUIREMENTS.mdå­˜åœ¨"
    echo "   2. æ£€æŸ¥æ–‡æ¡£æ˜¯å¦åŒ…å«æ‰€æœ‰å¿…è¦ç« èŠ‚"
    echo "   3. ç¡®ä¿æ–‡æ¡£ç‰ˆæœ¬å·å·²æ›´æ–°"
    echo ""
    echo "ðŸš« åœ¨æ–‡æ¡£æ ¡éªŒé€šè¿‡ä¹‹å‰ï¼Œä¸èƒ½ç»§ç»­ä»£ç ä¿®æ”¹ï¼"
    exit 1
fi

echo ""
echo "ðŸ”’ æ­¥éª¤2ï¼šæ£€æŸ¥ä»£ç çº¦æŸåˆè§„æ€§..."
./scripts/constraint_check.sh
CONSTRAINT_CHECK_RESULT=$?

if [ $CONSTRAINT_CHECK_RESULT -ne 0 ]; then
    echo ""
    echo "âŒ çº¦æŸæ£€æŸ¥å¤±è´¥ï¼"
    echo "ðŸ› ï¸  è§£å†³æ–¹æ¡ˆï¼š"
    echo "   1. æ£€æŸ¥æŠ€æœ¯æ ˆæ˜¯å¦ç¬¦åˆè¦æ±‚"
    echo "   2. ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®"
    echo "   3. ç§»é™¤è¶…å‡ºæ–‡æ¡£èŒƒå›´çš„åŠŸèƒ½"
    echo "   4. ä¿®æ­£æŽ¥å£å®šä¹‰å’Œæ•°æ®æ ¼å¼"
    echo ""
    echo "ðŸš« åœ¨çº¦æŸæ£€æŸ¥é€šè¿‡ä¹‹å‰ï¼Œä¸èƒ½ç»§ç»­ä»£ç ä¿®æ”¹ï¼"
    exit 1
fi

echo ""
echo "ðŸ” æ­¥éª¤3ï¼šæ£€æŸ¥æ˜¯å¦æœ‰æœªæ–‡æ¡£åŒ–çš„å˜æ›´..."

# æ£€æŸ¥GitçŠ¶æ€ï¼ˆå¦‚æžœå­˜åœ¨Gitä»“åº“ï¼‰
if [ -d ".git" ]; then
    MODIFIED_FILES=$(git status --porcelain 2>/dev/null | grep -c "M ")
    if [ "$MODIFIED_FILES" -gt 0 ]; then
        echo "âš ï¸  æ£€æµ‹åˆ° $MODIFIED_FILES ä¸ªæ–‡ä»¶å·²è¢«ä¿®æ”¹"
        echo ""
        echo "ðŸ“‹ ä¿®æ”¹å‰ç¡®è®¤æ¸…å•ï¼š"
        echo "   â–¡ å¦‚æžœæ˜¯éœ€æ±‚å˜æ›´ï¼Œè¯·å…ˆæ›´æ–°PROJECT_REQUIREMENTS.md"
        echo "   â–¡ å¦‚æžœæ˜¯ä»£ç å®žçŽ°ï¼Œè¯·ç¡®è®¤ç¬¦åˆæ–‡æ¡£è¦æ±‚"
        echo "   â–¡ å¦‚æžœæ˜¯Bugä¿®å¤ï¼Œè¯·ç¡®è®¤ä¸æ”¹å˜åŠŸèƒ½èŒƒå›´"
        echo ""
        echo "ðŸ¤” è¯·ç¡®è®¤æ˜¯å¦ç»§ç»­ï¼š"
        echo "   - è¾“å…¥ 'continue' ç»§ç»­æ‰§è¡Œ"
        echo "   - è¾“å…¥å…¶ä»–ä»»ä½•å†…å®¹å–æ¶ˆæ“ä½œ"
        echo ""
        read -p "è¯·è¾“å…¥ç¡®è®¤: " confirmation
        
        if [ "$confirmation" != "continue" ]; then
            echo "âŒ ç”¨æˆ·å–æ¶ˆæ“ä½œ"
            echo "ðŸš« æ“ä½œå·²å–æ¶ˆï¼Œè¯·å…ˆå¤„ç†ä¸Šè¿°ç¡®è®¤äº‹é¡¹"
            exit 1
        fi
        
        echo "âœ… ç”¨æˆ·ç¡®è®¤ç»§ç»­"
    else
        echo "âœ… æœªæ£€æµ‹åˆ°æ–‡ä»¶ä¿®æ”¹"
    fi
else
    echo "â„¹ï¸  æœªæ£€æµ‹åˆ°Gitä»“åº“ï¼Œè·³è¿‡æ–‡ä»¶ä¿®æ”¹æ£€æŸ¥"
fi

echo ""
echo "ðŸ” æ­¥éª¤4ï¼šæ£€æŸ¥è„šæœ¬æ‰§è¡Œæƒé™..."

# ç¡®ä¿æ‰€æœ‰è„šæœ¬éƒ½æœ‰æ‰§è¡Œæƒé™
SCRIPTS=("validate_document.sh" "constraint_check.sh" "pre_commit_check.sh")
for script in "${SCRIPTS[@]}"; do
    if [ ! -x "scripts/$script" ]; then
        echo "ðŸ”§ è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™ï¼šscripts/$script"
        chmod +x "scripts/$script"
    fi
done

echo "âœ… è„šæœ¬æƒé™æ£€æŸ¥å®Œæˆ"

echo ""
echo "ðŸ” æ­¥éª¤5ï¼šç”Ÿæˆæ£€æŸ¥æŠ¥å‘Š..."

# ç”Ÿæˆæ£€æŸ¥æŠ¥å‘Š
REPORT_FILE="CONSTRAINT_CHECK_REPORT_$(date +%Y%m%d_%H%M%S).txt"
cat > "$REPORT_FILE" << EOF
çº¦æŸæ£€æŸ¥æŠ¥å‘Š
ç”Ÿæˆæ—¶é—´: $(date)
é¡¹ç›®è·¯å¾„: $(pwd)

æ£€æŸ¥ç»“æžœ:
âœ… æ–‡æ¡£æ ¡éªŒ: é€šè¿‡
âœ… çº¦æŸæ£€æŸ¥: é€šè¿‡
âœ… æƒé™æ£€æŸ¥: é€šè¿‡

æ–‡æ¡£ç‰ˆæœ¬: $(grep "æœ¬æ–‡æ¡£ç‰ˆæœ¬ï¼š" PROJECT_REQUIREMENTS.md | cut -d':' -f2 | tr -d ' ')
æ£€æŸ¥è„šæœ¬ç‰ˆæœ¬: 1.0.0

çŠ¶æ€: âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥å¼€å§‹ä»£ç ä¿®æ”¹

æ³¨æ„:
- ä»»ä½•ä»£ç ä¿®æ”¹éƒ½å¿…é¡»ä¸¥æ ¼éµå¾ªPROJECT_REQUIREMENTS.md
- å¦‚éœ€éœ€æ±‚å˜æ›´ï¼Œå¿…é¡»å…ˆæ›´æ–°æ–‡æ¡£å†ä¿®æ”¹ä»£ç 
- è¿åçº¦æŸçš„ä»£ç å°†è¢«æ‹’ç»
